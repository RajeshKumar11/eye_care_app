name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  pr-validation:
    name: Validate Pull Request
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
          requireScope: false

      - name: Check for CHANGELOG update
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "✅ CHANGELOG.md has been updated"
          else
            echo "⚠️ WARNING: CHANGELOG.md has not been updated"
            echo "Please update CHANGELOG.md with your changes"
            exit 0  # Warning only, not failure
          fi

      - name: Check file sizes
        run: |
          echo "Checking for large files..."
          large_files=$(find . -type f -size +5M -not -path "./.git/*" -not -path "./build/*")
          if [ -n "$large_files" ]; then
            echo "❌ Large files detected (>5MB):"
            echo "$large_files"
            echo "Please use Git LFS for large files"
            exit 1
          else
            echo "✅ No large files detected"
          fi

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.4'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check formatting
        run: |
          if ! dart format --output=none --set-exit-if-changed .; then
            echo "❌ Code formatting issues detected"
            echo "Run 'dart format .' to fix"
            exit 1
          fi
          echo "✅ Code is properly formatted"

      - name: Analyze code
        run: flutter analyze

      - name: Check for TODOs
        run: |
          todos=$(grep -r "TODO" --include="*.dart" lib/ || true)
          if [ -n "$todos" ]; then
            echo "⚠️ TODOs found in code:"
            echo "$todos"
            echo ""
            echo "Consider creating issues for these TODOs"
          else
            echo "✅ No TODOs found"
          fi

      - name: Check pubspec.yaml
        run: |
          if flutter pub publish --dry-run; then
            echo "✅ pubspec.yaml is valid"
          else
            echo "❌ pubspec.yaml has issues"
            exit 1
          fi

  dependencies:
    name: Dependency Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.10.4'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          flutter pub outdated || true
          echo ""
          echo "Consider updating dependencies if there are security fixes"

      - name: Analyze dependencies
        run: flutter pub deps

  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          additions=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= insertion)' || echo "0")
          deletions=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oP '\d+(?= deletion)' || echo "0")
          total=$((additions + deletions))

          echo "PR Stats:"
          echo "  Additions: $additions"
          echo "  Deletions: $deletions"
          echo "  Total changes: $total"

          if [ $total -gt 1000 ]; then
            echo "⚠️ WARNING: Large PR detected ($total lines changed)"
            echo "Consider breaking this into smaller PRs for easier review"
          elif [ $total -gt 500 ]; then
            echo "ℹ️ Medium-sized PR ($total lines changed)"
          else
            echo "✅ Small PR ($total lines changed)"
          fi

  label-check:
    name: Label Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: Check for labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            if (labels.length === 0) {
              core.warning('No labels on this PR. Please add appropriate labels.');
            } else {
              core.info(`Labels: ${labels.join(', ')}`);
            }
